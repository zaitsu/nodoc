# 機関投資家レベルのイーサリアムステーキングアドレスアーキテクチャ：Trezorベース運用のための統合ブループリント：フェーズ2

ハードウェアウォレットと階層的アドレス構造を踏まえて設計する

この設計は、Trezorの単一マスターシード（リカバリーフレーズ）と、複数のパスフレーズを組み合わせることで、セキュリティレベルと役割に応じてウォレットセットを完全に分離し、各ウォレットセット内でBIP-44アカウントを体系的に利用することを基本方針とする

※ Ledgerを使わない理由は高価なためなので、後でLedgerに変える可能性もあり

## 基本戦略

- **単一の真実の源泉**: 1つのマスターシード（20単語）を物理的に厳重保管（金属板推奨、複数箇所分散）。これが全ての資産への最終的なアクセスキーとなる
    - 後々、マルチシェアバックアップに切り替えられるよう、シングルシェアバックアップとして作成するため、20単語となる ([参考リンク](https://trezor.io/guides/backups-recovery/advanced-wallets/multi-share-backup-on-trezor))
- **パスフレーズによる役割の完全分離**: パスフレーズを変えるだけで全く別のウォレットセット（隠しウォレット）にアクセスできるTrezorの機能を最大限に活用し、セキュリティドメインを分割する
- **BIP-44アカウントによる論理整理**: 各パスフレーズウォレット内で、BIP-44のアカウントインデックス (`account'`) を利用して、プロトコルごと、あるいは目的ごとに資金と権限を論理的に整理する
- **Safe{Wallet}による中央集権的リスクの排除**: 重要な資産管理と操作は、各メンバーが個別に管理するTrezor内のEOAをオーナーとするM-of-Nマルチシグ（Safe{Wallet}）に集約する
- **0xSplitsによる分配の自動化と透明化**: 報酬分配のルールをオンチェーンで管理し、柔軟性と透明性を確保する

## アドレス設計詳細

各役割に対応するEOA（Externally Owned Account）が、どのTrezorウォレットセット（パスフレーズで区別）のどのアカウントから導出されるかを示す

### 凡例:

- **Trezorウォレットセット**: どのパスフレーズで保護されたウォレットかを示す
- **BIP-44パス**: 導出パスの構造 `m / 44' / 60' / account' / change / address_index` を示す
- **EOA**: Externally Owned Account（Trezorで秘密鍵が管理される通常のアドレス）
- **コントラクト**: Safe{Wallet}や0xSplitsなどのスマートコントラクトアドレス

### 階層1: 最重要管理レイヤー（パスフレーズA: MasterAdminVault）

このパスフレーズはチーム内で最も厳重に管理し、アクセスできるメンバーを限定するため、プロトコル全体の根幹に関わる操作に使用する

| 役割                                 | アドレスタイプ | BIP-44アカウント (`account'`) | 導出パスの例 (`m/44'/60'/...`) | 管理・備考   |
| :----------------------------------- | :----------- | :--------------------------- | :---------------------------------- | :--------------------------------------------------------------------------------------------------------------------------------------- |
| **中央報酬管理 Safe{Wallet}** | コントラクト | N/A                          | N/A                                 | 全てのプロトコルからの報酬（ETH, stETH, pufETH, RPLなど）を集約する中央金庫。このコントラクトアドレスが各プロトコルの報酬受取先に指定される。|
| Safe{Wallet} オーナー 1 (EOA)        | EOA          | `Account 0`                  | `0'/0/0`                            | 中央報酬管理Safe{Wallet}のオーナー署名者1。各メンバーが自身のTrezor（`MasterAdminVault`パスフレーズ）のこのパスから導出したEOAをオーナーとして登録。 |
| Safe{Wallet} オーナー 2 (EOA)        | EOA          | `Account 0`                  | `0'/0/1`                            | （オプション）M-of-N構成のための追加オーナー署名者2。 |
| ... (Safe{Wallet} オーナー N)      | EOA          | `Account 0`                  | `0'/0/{N-1}`                        | チームメンバー数に応じて追加。|
| **運用資金管理 Safe{Wallet}** | コントラクト | N/A                          | N/A                                 | （オプション、より高度な分離）ガス代供給、DVT手数料支払い、VT購入などの運用経費を管理するマルチシグ。中央報酬管理Safe{Wallet}から資金を移動して使用。 |
| **0xSplitsマスターコントローラー (EOA)** | EOA          | `Account 1`                  | `1'/0/0`                            | 全ての0xSplitsコントラクトの設定変更権限を持つマスターEOA。このEOA自体をSafe{Wallet}のオーナーとして設定し、0xSplitsの管理もマルチシグで行うことを強く推奨。 |

### 階層2: プロトコル別オペレーションレイヤー（パスフレーズB: ProtocolOperations）

このパスフレーズは、各プロトコルとの直接的な対話（オペレーター登録、ボンド拠出など）を行うEOAを管理する

| 役割                                    | アドレスタイプ | BIP-44アカウント (`account'`) | 導出パスの例 (`m/44'/60'/...`) | 管理・備考 |
| :-------------------------------------- | :----------- | :--------------------------- | :---------------------------------- | :----------------------------------------------------------------------------------------------------------------------------------- |
| **Lido CSM オペレーター管理 (EOA)** | EOA          | `Account 0` (`Lido`)         | `0'/0/0`                            | Lido CSMへのオペレーター登録、ボンド拠出、設定変更など。資金は階層1のSafe{Wallet}から供給。|
| **Rocket Pool ノード管理 (EOA)** | EOA          | `Account 1` (`RocketPool`)   | `1'/0/0`                            | 8ETH Minipoolの作成、RPL担保のステーキング/請求、ノード登録など。報酬請求後、資金は階層1のSafe{Wallet}へ移動。 |
| **Puffer.fi オペレーター管理 (EOA)** | EOA          | `Account 2` (`Puffer`)       | `2'/0/0`                            | Puffer.fiへのNoOp登録、2ETH pufETHボンド拠出、Validator Ticketの購入など。報酬は階層1のSafe{Wallet}へ集約。 |
| **Diva Staking オペレーター管理 (EOA)** | EOA          | `Account 3` (`Diva`)         | `3'/0/0`                            | Diva Stakingへのオペレーター登録、1 divETH担保のロックなど。報酬は階層1のSafe{Wallet}へ集約。 |
| (将来のプロトコルX 管理 EOA)            | EOA          | `Account 4` (`ProtocolX`)    | `4'/0/0`                            | 新たなボンデッドバリデーターやステーキングプロトコルに参加する際の拡張用。アカウントインデックスを増やすことで無限に拡張可能。|

### 階層3: DVTノードキーレイヤー（パスフレーズC: DVTNodeKeys）

このパスフレーズは、オンラインのDVTノードソフトウェアと連携する必要があるオペレーターキー専用で、他の資金や権限から完全に隔離する

| 役割                                       | アドレスタイプ | BIP-44アカウント (`account'`) | 導出パスの例 (`m/44'/60'/...`) | 管理・備考 |
| :----------------------------------------- | :----------- | :--------------------------- | :---------------------------------- | :------------------------------------------------------------------------------------------------------------------- |
| **SSV オペレーターキー 1-1 (EOA)** | EOA          | `Account 0` (`SSV_Cluster1`) | `0'/0/0`                            | SSV Cluster 1のオペレーター1のキー。SSVノードソフトウェアにこのEOAの秘密鍵情報（またはTrezorとの連携）を設定。ガス代は階層1のSafe{Wallet}から少量供給。 |
| ... (SSV オペレーターキー N-M)             | EOA          | `Account N-1` (`SSV_ClusterN`) | `(N-1)'/0/{M-1}`                    | クラスターやオペレーターインスタンスが増えるたびに、アカウントインデックスやアドレスインデックスを増やして対応。 |
| **Obol オペレーターキー 1-1 (EOA)** | EOA          | `Account 10` (`Obol_Cluster1`) | `10'/0/0`                           | Obol Cluster 1のオペレーター1のキー（Charonクライアント用）。SSVとアカウントインデックスを大きく離すことで混同を避ける。|
| ... (Obol オペレーターキー N-M)            | EOA          | `Account 10+N-1` (`Obol_ClusterN`)| `(10+N-1)'/0/{M-1}`                 | 同様に拡張可能。 |

### 階層4: 報酬分配・最終受取レイヤー

| 役割                                      | アドレスタイプ | BIP-44アカウント (`account'`) | 導出パスの例 (`m/44'/60'/...`) | 管理・備考 |
| :---------------------------------------- | :----------- | :--------------------------- | :---------------------------------- | :---------------------------------------------------------------------------------------------------------------------------------------- |
| **0xSplits 報酬分配コントラクト** | コントラクト | N/A                          | N/A                                 | 階層1のSafe{Wallet}から送金された報酬を、設定されたルールに従って分配する。プロトコルごと、あるいは報酬トークンごとに別々のSplitコントラクトを作成することも可能。  |
| **チーム共有経費プール (EOA)** | EOA          | パスフレーズD: `TeamFunds`          | `0'/0/0`                            | 0xSplitsの分配先の一つ。将来の運用コスト、緊急時費用などを積み立てる。このEOAもSafe{Wallet}で管理することでマルチシグ保護下に置ける。  |
| **個人最終報酬受取 EOA (メンバー1)** | EOA          | パスフレーズE: `PersonalPayout1`    | `0'/0/0`                            | 0xSplitsの分配先の一つ。各メンバーが自身で管理する最終的な報酬受取ウォレット。日常的なオペレーションからは完全に分離し、コールドストレージとして扱うことを推奨。このパスフレーズは各メンバーが個人で管理。  |
| ... (個人最終報酬受取 EOA N)                | EOA          | パスフレーズF: `PersonalPayout2`...| `0'/0/0`                            | チームメンバーごとに専用のパスフレーズとウォレットセットを作成。  |

## アドレス設計を実現する際の課題

Trezor SuiteのUIだけでは、私たちが設計したような高度な階層構造を直感的に管理することは困難

「Trezor + MetaMask」という組み合わせを用いることで、Trezorの堅牢なセキュリティを維持したまま、BIP-44の`account'`レベルで完全に分離されたアドレス群を意図通りに生成・管理することが可能になる

これにより、提案したセキュリティと拡張性を両立するアドレス設計を、現実的なオペレーションとして実現することができる

### Trezor SuiteのUI挙動とBIP-44標準の解説

BIP-44で定義されている **「アカウント (`account'`)」と「アドレスインデックス (`address_index`)」** の違いに起因する

- アカウント (`m/44'/c'/X'/...`): 会計上の分離を目的とした、大きな資金のグループです
    - 例えば、「貯蓄用アカウント」「取引手数料用アカウント」のように、目的ごとに完全に分離された勘定と考えることができる
- アドレスインデックス (`.../0/a`): 1つのアカウント内で、トランザクションのプライバシーを高めるために使用される個々のアドレス

Trezor SuiteのUIで「新しいアカウントを追加」をクリックした際に、どの部分がインクリメントされるかについては、歴史的な経緯やUIの設計思想により、ユーザーの観測と技術的な理想が異なる場合がある

- 多くのシンプルなウォレットUIでは、まず`Account 0` (`m/44'/60'/0'/...`) 内のアドレス (`.../0/0`, `.../0/1`, `.../0/2` ...) を順番に生成・表示しようとする
- 多くのシンプルなウォレットUIでは、ユーザーがUI上で「アカウント」と認識しているものが、実際にはこの`Account 0`内のアドレス群である場合がある

Trezorデバイス自体はBIP-44標準に完全準拠しており、任意の導出パス（例えば`m/44'/60'/10'/0/0`など）のアドレスでトランザクションに署名する能力を持っているため、提案したアドレス設計の有効性は変わらない

**問題は「UI上で、どのようにしてそれらのアドレスにアクセスし、管理するか」という点に集約される**

## アドレス設計を実現するための解決策

### 設計を実現するための現実的かつセキュアな解決策

Trezor SuiteのUI上の制約を乗り越え、提案した高度なアドレス設計を実現するための最も現実的でセキュアな方法は、MetaMaskのようなサードパーティ製インターフェースをTrezorと連携させること

#### 具体的な手順（MetaMaskを利用する場合）

1. MetaMaskの準備: ブラウザにMetaMask拡張機能がインストールされていることを確認する
1. Trezorを接続:
    - MetaMaskを開き、右上のアカウントアイコンをクリック
    - 表示されたメニューから「ハードウェアウォレットを接続」を選択
    - Trezorのアイコンを選択し、「続行」をクリック
1. パスフレーズの入力:
    - Trezorデバイスを接続すると、Trezor Connectのポップアップウィンドウが表示される
    - ここで、アクセスしたいウォレットセットに対応するパスフレーズを入力する（例：階層2の「ProtocolOperations」用のアドレスにアクセスしたい場合は、そのパスフレーズを入力し、標準ウォレットの場合は空のまま進む）
1. 【最重要】アカウントの選択:
    - パスフレーズが承認されると、MetaMaskはTrezorから導出可能なEthereumアカウントのリストを表示する
    - このリストには、`m/44'/60'/0'/0/0` (Account 1)、`m/44'/60'/1'/0/0` (Account 2)、`m/44'/60'/2'/0/0` (Account 3) ... というように、BIP-44のaccount'レベルでインクリメントされたアドレスが順番に表示される
    - ここで、設計上使用したいアカウントのチェックボックスを選択します。 例えば、Rocket Pool用に`Account 1` (`1'/0/0`)、Puffer.fi用に`Account 2` (`2'/0/0`) を同時にインポートすることも可能
    - Trezor Suiteでは表示されなかった、残高が0の先のインデックスのアカウントも、この画面で選択・インポートできる
1. アカウントのインポートとラベリング:
    - 「ロック解除」をクリックすると、選択したアカウントがMetaMaskのウォレットリストに追加される
    - MetaMask上で、各アカウントに設計通りの名前（例：「HW - Lido Ops」「HW - RocketPool Ops」）を付けることで、管理が容易になる

### このアプローチのメリットとセキュリティ

- 設計の完全な実現: Trezor SuiteのUI上のGap Limit問題を完全に回避し、BIP-44のaccount'レベルで分離されたアドレスを意図通りに利用できる
- 利便性の向上: 一度MetaMaskにインポートすれば、DeFiプロトコルとの連携やトランザクションの実行がスムーズになる
- セキュリティの維持: この方法でも、秘密鍵やリカバリーシードはTrezorデバイスから一切外に出ず、MetaMaskはあくまでトランザクションを構築し、署名をTrezorに要求するだけの「安全な窓口」として機能する

### 実行時の注意点

- トランザクションに署名する際は、必ずTrezorデバイス本体の画面に表示される送金先アドレスや金額、コントラクトデータが正しいことを最終確認する
- 異なるパスフレーズで保護されたウォレットセット（例：ProtocolOperationsとDVTNodeKeys）のアドレスを同時に管理したい場合は、一度MetaMaskからハードウェアウォレットの接続を解除し、再度接続プロセスを繰り返して別のパスフレーズを入力する必要がある
